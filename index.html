<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Yeat Stats — Fast & Fixed</title>

  <!-- Core libs -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js" crossorigin></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root {
      --card-bg: rgba(255,255,255,0.03);
      --muted: rgba(255,255,255,0.6);
    }
    html,body { height:100%; }
    body {
      margin:0;
      min-height:100%;
      background: linear-gradient(180deg,#000000 0%, #0b0b0b 45%, #050505 100%);
      color: #fff;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .card {
      background: var(--card-bg);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 12px;
      padding: 14px;
      backdrop-filter: blur(6px);
    }
    .muted { color: var(--muted); }
    .pill { border-radius:999px; padding:6px 12px; }
    .hover-glow:hover { box-shadow: 0 6px 20px rgba(255,255,255,0.03); transform: translateY(-2px); transition:0.18s; }
    .shimmer {
      background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.06) 50%, rgba(255,255,255,0.03) 100%);
      background-size: 200% 100%;
      animation: shimmer 1.25s linear infinite;
    }
    @keyframes shimmer { from { background-position: -200% 0; } to { background-position: 200% 0; } }
    .small { font-size: 13px; }
    .table-scroll { max-height: 60vh; overflow:auto; }
    .sortable { cursor:pointer; user-select:none; }
    .positive { color: #34D399; }
    .negative { color: #FB7185; }
    @media (max-width:640px) {
      .desktop-only { display:none; }
      .mobile-card { display:block; }
    }
    @media (min-width:641px) {
      .mobile-card { display:none; }
    }
  </style>
</head>
<body>
  <div id="root" class="p-4 sm:p-8"></div>

<script type="text/babel">
/**
 * Yeat Stats — GITHUB PAGES FIXED (WORKING)
 * - Embedded base64 CSVs
 * - No fetch() = Works on GitHub Pages
 * - Fixed React.useState typo
 */

const CSV_DATA = {
  // PASTE YOUR BASE64 CSVs HERE
  // Example:
  // '2025-10-22': 'U29uZyxBbGJ1bSxTcG90aWZ5IGRhaWx5LFNwb3RpZnkgdG90YWwKTmV3IFNvbmcsTmV3IEFsYnVtLDEyMzQ1Niw3ODkwMTIz',
  // '2025-10-21': 'U29uZyxBbGJ1bSxTcG90aWZ5IGRhaWx5LFNwb3RpZnkgdG90YWwKTmV3IFNvbmcsTmV3IEFsYnVtLDEwMDAwMCw3Nzc3Nzc3',
};

/* ------------------ Base64 Decoder ------------------ */
function decodeCSV(base64) {
  try {
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
      bytes[i] = binary.charCodeAt(i);
    }
    return new TextDecoder().decode(bytes);
  } catch (e) {
    console.error('Base64 decode error:', e);
    return '';
  }
}

/* ------------------ Utilities ------------------ */
const formatNum = (n) => (n || 0).toLocaleString('en-US');
const parseIntSafe = s => {
  if (!s) return 0;
  const n = parseInt((''+s).replace(/,/g,'').trim(), 10);
  return isNaN(n) ? 0 : n;
};
const dateToStr = d => d.toISOString().split('T')[0];
const strToDate = s => new Date(s + 'T00:00:00Z');

/* ------------------ CSV Parser ------------------ */
function parseCSV(text) {
  try {
    const result = Papa.parse(text, { 
      header: true, 
      skipEmptyLines: true,
      dynamicTyping: false,
      transformHeader: h => h.trim().toLowerCase()
    });
    return result.data || [];
  } catch (e) {
    console.error('Parse error:', e);
    return [];
  }
}

/* ------------------ App ------------------ */
function App() {
  const [loading, setLoading] = React.useState(true);
  const [loadingMessage, setLoadingMessage] = React.useState('Loading...');
  const [error, setError] = React.useState(null);
  const [latestDate, setLatestDate] = React.useState(null);
  const [songs, setSongs] = React.useState([]);
  const [albums, setAlbums] = React.useState([]);
  const [history, setHistory] = React.useState({});
  const [activeTab, setActiveTab] = React.useState('songs');
  const [search, setSearch] = React.useState('');  // FIXED: useState not setState
  const [sortConfig, setSortConfig] = React.useState({ key: 'streams', direction: 'desc' });
  const [chartModalOpen, setChartModalOpen] = React.useState(false);
  const [chartTargets, setChartTargets] = React.useState([]);
  const chartJsLoaded = React.useRef(false);

  React.useEffect(() => {
    (async () => {
      try {
        const dates = Object.keys(CSV_DATA).sort().reverse();
        if (dates.length === 0) {
          throw new Error('No CSV data found. Add base64 CSVs to CSV_DATA.');
        }

        const latest = dates[0];
        setLatestDate(latest);
        setLoadingMessage('Decoding CSVs...');

        // Decode latest
        const latestText = decodeCSV(CSV_DATA[latest]);
        if (!latestText) throw new Error('Failed to decode latest CSV.');

        // Find 28-day-old CSV
        const targetDate = new Date(strToDate(latest));
        targetDate.setDate(targetDate.getDate() - 28);
        const oldDateStr = dateToStr(targetDate);

        const oldDate = dates.find(d => d <= oldDateStr) || dates[dates.length - 1];
        const oldText = decodeCSV(CSV_DATA[oldDate]);

        // Parse
        const latestRows = parseCSV(latestText);
        const oldRows = parseCSV(oldText);

        setLoadingMessage('Calculating...');

        // Build old total map
        const oldMap = {};
        oldRows.forEach(row => {
          const title = (row.song || '').trim();
          const album = (row.album || '').trim();
          if (!title) return;
          const key = `${title}|${album}`;
          oldMap[key] = parseIntSafe(row['spotify total']);
        });

        // Build songs
        const songMap = {};
        latestRows.forEach(row => {
          const title = (row.song || '').trim();
          const album = (row.album || '').trim();
          if (!title) return;
          const key = `${title}|${album}`;
          const total = parseIntSafe(row['spotify total']);
          const daily = parseIntSafe(row['spotify daily']);
          const oldTotal = oldMap[key] || 0;
          const growth = oldTotal > 0 
            ? ((total - oldTotal) / oldTotal) * 100 
            : (oldTotal === 0 && total > 0 ? 999999 : 0);
          songMap[key] = { title, album, streams: total, daily, growth };
        });

        const songsArr = Object.values(songMap);

        // Build albums
        const albumMap = {};
        songsArr.forEach(s => {
          const a = s.album || 'Unknown';
          if (!albumMap[a]) albumMap[a] = { title: a, streams: 0, daily: 0, tracks: 0, growths: [] };
          albumMap[a].streams += s.streams;
          albumMap[a].daily += s.daily;
          albumMap[a].tracks += 1;
          if (s.growth !== 999999 && isFinite(s.growth)) albumMap[a].growths.push(s.growth);
        });

        const albumsArr = Object.values(albumMap).map(a => ({
          ...a,
          growth: a.growths.length ? a.growths.reduce((x,y)=>x+y,0)/a.growths.length : 0
        }));

        setSongs(songsArr);
        setAlbums(albumsArr);

        // Build history
        const hist = {};
        const totalHist = [];
        dates.forEach(date => {
          const text = decodeCSV(CSV_DATA[date]);
          const rows = parseCSV(text);
          let dailySum = 0, totalSum = 0;
          rows.forEach(row => {
            const title = (row.song || '').trim();
            const album = (row.album || '').trim();
            if (!title) return;
            const key = `${title}|${album}`;
            const daily = parseIntSafe(row['spotify daily']);
            const total = parseIntSafe(row['spotify total']);
            if (!hist[key]) hist[key] = [];
            hist[key].push({ date, streams: total, daily });
            dailySum += daily;
            totalSum += total;
          });
          totalHist.push({ date, streams: totalSum, daily: dailySum });
        });

        Object.keys(hist).forEach(k => hist[k].sort((a,b) => a.date.localeCompare(b.date)));
        totalHist.sort((a,b) => a.date.localeCompare(b.date));

        setHistory(hist);
        setLoading(false);
      } catch (e) {
        console.error(e);
        setError(e.message);
        setLoading(false);
      }
    })();
  }, []);

  const requestSort = (key) => {
    setSortConfig(prev => ({
      key,
      direction: prev.key === key && prev.direction === 'desc' ? 'asc' : 'desc'
    }));
  };

  const applySort = (arr) => {
    const { key, direction } = sortConfig;
    return [...arr].sort((a, b) => {
      const va = a[key] ?? -Infinity;
      const vb = b[key] ?? -Infinity;
      if (typeof va === 'string') return direction === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
      return direction === 'asc' ? va - vb : vb - va;
    });
  };

  const displayedSongs = React.useMemo(() => {
    let arr = songs;
    if (search) arr = arr.filter(s => 
      s.title.toLowerCase().includes(search.toLowerCase()) || 
      s.album.toLowerCase().includes(search.toLowerCase())
    );
    return applySort(arr);
  }, [songs, search, sortConfig]);

  const displayedAlbums = React.useMemo(() => {
    let arr = albums;
    if (search) arr = arr.filter(a => a.title.toLowerCase().includes(search.toLowerCase()));
    return applySort(arr);
  }, [albums, search, sortConfig]);

  const openChart = async () => {
    const targets = activeTab === 'songs'
      ? displayedSongs.slice(0, 3).map(s => `${s.title}|${s.album}`)
      : displayedAlbums.slice(0, 3).map(a => `ALBUM::${a.title}`);
    setChartTargets(targets);
    setChartModalOpen(true);

    if (!chartJsLoaded.current) {
      await new Promise((res, rej) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js';
        script.onload = () => { chartJsLoaded.current = true; res(); };
        script.onerror = rej;
        document.head.appendChild(script);
      });
    }
  };

  if (loading) {
    return (
      <div className="max-w-6xl mx-auto">
        <div className="card text-center py-12">
          <div className="h-8 shimmer rounded w-64 mx-auto mb-4"></div>
          <p className="muted">{loadingMessage}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-6xl mx-auto">
      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-2xl font-semibold">Yeat Spotify Stats</h1>
          <p className="small muted">Latest: {latestDate}</p>
        </div>
        <input
          placeholder="Search..."
          className="px-3 py-2 rounded bg-black border border-white/10 small"
          value={search}
          onChange={e => setSearch(e.target.value)}
        />
      </div>

      {error && <div className="card text-red-400 mb-4">Error: {error}</div>}

      <div className="card mb-4">
        <div className="flex gap-2">
          <button className={`pill ${activeTab==='songs'?'bg-white text-black':'border border-white/10'}`} onClick={()=>setActiveTab('songs')}>
            Songs ({songs.length})
          </button>
          <button className={`pill ${activeTab==='albums'?'bg-white text-black':'border border-white/10'}`} onClick={()=>setActiveTab('albums')}>
            Albums ({albums.length})
          </button>
        </div>
      </div>

      <div className="card table-scroll">
        <table className="w-full small">
          <thead className="text-white/70">
            <tr>
              <th className="text-left py-2 w-8">#</th>
              <th className="text-left py-2 sortable" onClick={()=>requestSort('title')}>
                {activeTab==='songs'?'Song':'Album'}
                {sortConfig.key==='title' ? (sortConfig.direction==='asc'?' Up':' Down') : ''}
              </th>
              {activeTab==='songs' && <th className="text-left py-2">Album</th>}
              {activeTab==='albums' && <th className="text-right py-2">Tracks</th>}
              <th className="text-right py-2 sortable" onClick={()=>requestSort('streams')}>Streams</th>
              <th className="text-right py-2 sortable" onClick={()=>requestSort('daily')}>Daily</th>
              <th className="text-right py-2 sortable" onClick={()=>requestSort('growth')}>28d Growth</th>
            </tr>
          </thead>
          <tbody>
            {(activeTab === 'songs' ? displayedSongs : displayedAlbums).map((item, i) => (
              <tr key={i} className="border-t border-white/5 hover-glow">
                <td className="py-3 text-white/60">{i+1}</td>
                <td className="py-3">{item.title}</td>
                {activeTab==='songs' && <td className="py-3 text-white/60 small">{item.album}</td>}
                {activeTab==='albums' && <td className="py-3 text-right text-white/60 small">{item.tracks}</td>}
                <td className="py-3 text-right">{formatNum(item.streams)}</td>
                <td className="py-3 text-right">{formatNum(item.daily)}</td>
                <td className={`py-3 text-right ${item.growth >= 0 ? 'positive' : 'negative'}`}>
                  {item.growth === 999999 ? 'new' : `${item.growth >= 0 ? '+' : ''}${item.growth.toFixed(2)}%`}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <button className="pill border border-white/10 mt-4" onClick={openChart}>
        Compare Charts
      </button>

      {chartModalOpen && (
        <ChartModal onClose={() => setChartModalOpen(false)} targets={chartTargets} history={history} />
      )}
    </div>
  );
}

/* ------------------ Chart Modal ------------------ */
function ChartModal({ onClose, targets, history }) {
  const canvas = React.useRef(null);
  const chart = React.useRef(null);

  React.useEffect(() => {
    if (!window.Chart || !targets.length) return;

    const allDates = new Set();
    targets.forEach(t => {
      if (t.startsWith('ALBUM::')) {
        const album = t.slice(8);
        Object.keys(history).filter(k => k.endsWith('|' + album)).forEach(k => 
          history[k].forEach(r => allDates.add(r.date))
        );
      } else {
        (history[t] || []).forEach(r => allDates.add(r.date));
      }
    });

    const dates = Array.from(allDates).sort();
    const colors = ['#60A5FA','#F87171','#34D399','#FBBF24','#A78BFA','#EC4899','#10B981'];

    const datasets = targets.map((t, i) => {
      let data = [];
      if (t.startsWith('ALBUM::')) {
        const album = t.slice(8);
        const map = {};
        Object.keys(history).filter(k => k.endsWith('|' + album)).forEach(k => {
          history[k].forEach(r => {
            map[r.date] = (map[r.date] || 0) + r.daily;
          });
        });
        data = dates.map(d => map[d] || 0);
      } else {
        const map = {};
        (history[t] || []).forEach(r => map[r.date] = r.daily);
        data = dates.map(d => map[d] || 0);
      }
      return {
        label: t.includes('|') ? t.split('|')[0] : t.slice(8),
        data,
        borderColor: colors[i % colors.length],
        backgroundColor: colors[i % colors.length] + '33',
        tension: 0.3,
        fill: true
      };
    });

    const ctx = canvas.current.getContext('2d');
    if (chart.current) chart.current.destroy();
    chart.current = new Chart(ctx, {
      type: 'line',
      data: { labels: dates.map(d => new Date(d).toLocaleDateString('en', {month:'short', day:'numeric'})), datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { labels: { color: '#fff' } } },
        scales: {
          x: { ticks: { color: '#fff' }, grid: { color: '#3333' } },
          y: { ticks: { color: '#fff' }, grid: { color: '#3333' }, beginAtZero: true }
        }
      }
    });

    return () => chart.current?.destroy();
  }, [targets, history]);

  return (
    <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50" onClick={onClose}>
      <div className="card w-11/12 max-w-4xl h-96" onClick={e => e.stopPropagation()}>
        <div className="flex justify-between mb-2">
          <h3>Comparison</h3>
          <button className="pill border border-white/10" onClick={onClose}>Close</button>
        </div>
        <canvas ref={canvas} className="w-full h-80"></canvas>
      </div>
    </div>
  );
}

/* ------------------ Render ------------------ */
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(App));
</script>
</body>
</html>
