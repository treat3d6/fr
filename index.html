<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Yeat Stats - Fast Edition</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    body {
      background: linear-gradient(to bottom, #000, #0a0a0a);
      color: white;
      font-family: 'Inter', sans-serif;
    }
    .card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 1rem;
      padding: 1rem;
      backdrop-filter: blur(8px);
    }
    .hover-glow:hover {
      box-shadow: 0 0 12px rgba(255,255,255,0.1);
      transition: 0.2s;
    }
  </style>
</head>
<body class="p-4 sm:p-6">
  <div id="root"></div>

  <script type="text/babel">
    const YeatStats = () => {
      const [songs, setSongs] = React.useState([]);
      const [albums, setAlbums] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [error, setError] = React.useState(null);
      const [sortConfig, setSortConfig] = React.useState({ key: 'streams', direction: 'desc' });
      const [activeTab, setActiveTab] = React.useState('songs');
      const [searchTerm, setSearchTerm] = React.useState('');

      React.useEffect(() => {
        loadData();
      }, []);

      const loadData = async () => {
        try {
          const today = new Date();
          const endDate = today.toISOString().split('T')[0];
          const pastDate = new Date();
          pastDate.setDate(today.getDate() - 28);
          const startDate = pastDate.toISOString().split('T')[0];

          const [todayCSV, oldCSV] = await Promise.all([
            fetch(`./${endDate}.csv?t=${Date.now()}`),
            fetch(`./${startDate}.csv?t=${Date.now()}`)
          ]);

          const todayText = await todayCSV.text();
          const oldText = await oldCSV.text();

          const todayData = Papa.parse(todayText, { header: true }).data;
          const oldData = Papa.parse(oldText, { header: true }).data;

          const oldMap = {};
          oldData.forEach(r => {
            const key = `${r.Song}|${r.Album}`;
            oldMap[key] = parseInt((r['Spotify total'] || '0').replace(/,/g, '')) || 0;
          });

          const songMap = {};
          todayData.forEach(r => {
            const title = r.Song;
            const album = r.Album;
            const total = parseInt((r['Spotify total'] || '0').replace(/,/g, '')) || 0;
            const daily = parseInt((r['Spotify daily'] || '0').replace(/,/g, '')) || 0;
            const oldTotal = oldMap[`${title}|${album}`] || 0;
            const growth = oldTotal > 0 ? ((total - oldTotal) / oldTotal) * 100 : 0;
            songMap[`${title}|${album}`] = { title, album, streams: total, daily, growth };
          });

          const processedSongs = Object.values(songMap);
          const albumMap = {};
          processedSongs.forEach(s => {
            if (!albumMap[s.album]) albumMap[s.album] = { title: s.album, streams: 0, daily: 0, tracks: 0, growth: 0 };
            albumMap[s.album].streams += s.streams;
            albumMap[s.album].daily += s.daily;
            albumMap[s.album].tracks += 1;
          });
          Object.keys(albumMap).forEach(k => {
            const matchingOld = Object.values(songMap).filter(s => s.album === k);
            const avgGrowth = matchingOld.length ? matchingOld.reduce((a,b)=>a+b.growth,0)/matchingOld.length : 0;
            albumMap[k].growth = avgGrowth;
          });

          setSongs(processedSongs);
          setAlbums(Object.values(albumMap));
          setLoading(false);
        } catch (err) {
          console.error(err);
          setError('Failed to load data.');
          setLoading(false);
        }
      };

      const requestSort = (key) => {
        let direction = 'desc';
        if (sortConfig.key === key && sortConfig.direction === 'desc') direction = 'asc';
        setSortConfig({ key, direction });
      };

      const sortedData = (data) => {
        return [...data].sort((a, b) => {
          if (sortConfig.direction === 'asc') return a[sortConfig.key] - b[sortConfig.key];
          return b[sortConfig.key] - a[sortConfig.key];
        });
      };

      const filteredSongs = sortedData(songs.filter(s => s.title.toLowerCase().includes(searchTerm.toLowerCase()) || s.album.toLowerCase().includes(searchTerm.toLowerCase())));
      const filteredAlbums = sortedData(albums.filter(a => a.title.toLowerCase().includes(searchTerm.toLowerCase())));

      const data = activeTab === 'songs' ? filteredSongs : filteredAlbums;

      return (
        <div className="max-w-6xl mx-auto">
          <h1 className="text-2xl font-bold mb-4">Yeat Spotify Stats</h1>
          {loading && <p className="text-white/60">Loading data...</p>}
          {error && <p className="text-red-400">{error}</p>}

          {!loading && (
            <>
              <div className="flex flex-col sm:flex-row justify-between mb-4 gap-3">
                <div className="flex gap-2">
                  <button className={`px-4 py-2 rounded-full text-sm font-medium ${activeTab==='songs'?'bg-white text-black':'border border-white/20 text-white hover:bg-white/10'}`} onClick={()=>setActiveTab('songs')}>Songs</button>
                  <button className={`px-4 py-2 rounded-full text-sm font-medium ${activeTab==='albums'?'bg-white text-black':'border border-white/20 text-white hover:bg-white/10'}`} onClick={()=>setActiveTab('albums')}>Albums</button>
                </div>
                <input type="text" placeholder="Search..." className="px-4 py-2 text-sm rounded-lg border border-white/20 bg-black text-white placeholder-white/40" value={searchTerm} onChange={(e)=>setSearchTerm(e.target.value)} />
              </div>

              <div className="overflow-x-auto card">
                <table className="min-w-full text-sm">
                  <thead className="border-b border-white/10 text-white/70">
                    <tr>
                      <th className="text-left py-2">#</th>
                      <th className="text-left py-2 cursor-pointer" onClick={()=>requestSort('title')}>{activeTab==='songs'?'Song':'Album'} Title</th>
                      {activeTab==='songs' && <th className="text-left py-2">Album</th>}
                      {activeTab==='albums' && <th className="text-right py-2">Tracks</th>}
                      <th className="text-right py-2 cursor-pointer" onClick={()=>requestSort('streams')}>Streams</th>
                      <th className="text-right py-2 cursor-pointer" onClick={()=>requestSort('daily')}>Daily</th>
                      <th className="text-right py-2 cursor-pointer" onClick={()=>requestSort('growth')}>28d Growth %</th>
                    </tr>
                  </thead>
                  <tbody>
                    {data.map((item, idx)=>(
                      <tr key={idx} className="border-b border-white/5 hover-glow">
                        <td className="py-2 text-white/60">{idx+1}</td>
                        <td className="py-2">{item.title}</td>
                        {activeTab==='songs' && <td className="py-2 text-white/60">{item.album}</td>}
                        {activeTab==='albums' && <td className="text-right py-2 text-white/60">{item.tracks}</td>}
                        <td className="text-right py-2">{item.streams.toLocaleString()}</td>
                        <td className="text-right py-2">{item.daily.toLocaleString()}</td>
                        <td className={`text-right py-2 ${item.growth>=0?'text-green-400':'text-red-400'}`}>{item.growth.toFixed(2)}%</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<YeatStats />);
  </script>
</body>
</html>
